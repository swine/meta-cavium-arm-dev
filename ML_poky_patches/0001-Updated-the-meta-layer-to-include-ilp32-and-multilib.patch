From 7c1f6834666f0174243102e6db3ab2084e86f24b Mon Sep 17 00:00:00 2001
From: Manish Jaggi <mjaggi@cavium.com>
Date: Thu, 15 Dec 2016 21:13:33 -0800
Subject: [PATCH 1/3] Updated the meta layer to include ilp32 and multilib
 support

Signed-off-by: Manish Jaggi <mjaggi@cavium.com>
---
 meta/classes/cross-canadian.bbclass               | 2 +-
 meta/classes/insane.bbclass                       | 3 +++
 meta/classes/sanity.bbclass                       | 2 +-
 meta/classes/siteinfo.bbclass                     | 6 ++++++
 meta/recipes-devtools/gcc/gcc-multilib-config.inc | 2 ++
 5 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/meta/classes/cross-canadian.bbclass b/meta/classes/cross-canadian.bbclass
index d35451d..204b2af 100644
--- a/meta/classes/cross-canadian.bbclass
+++ b/meta/classes/cross-canadian.bbclass
@@ -34,7 +34,7 @@ python () {
 
     tos = d.getVar("TARGET_OS", True)
     whitelist = []
-    for variant in ["", "spe", "x32", "eabi", "n32"]:
+    for variant in ["", "spe", "x32", "eabi", "n32", "ilp32"]:
         for libc in ["", "uclibc", "musl"]:
             entry = "linux"
             if variant and libc:
diff --git a/meta/classes/insane.bbclass b/meta/classes/insane.bbclass
index a1d23d0..b7038e5 100644
--- a/meta/classes/insane.bbclass
+++ b/meta/classes/insane.bbclass
@@ -159,6 +159,9 @@ def package_qa_get_machine_dict():
                         "powerpc":    (20,     0,    0,          False,         32),
                         "sh4":        (42,     0,    0,          True,          32),
                       },
+            "linux-gnuilp32" :     {
+                        "aarch64" :   (183,    0,    0,          True,          32),
+                      },
             "linux-gnux32" :       {
                         "x86_64":     (62,     0,    0,          True,          32),
                       },
diff --git a/meta/classes/sanity.bbclass b/meta/classes/sanity.bbclass
index 77813e4..b9ecb95 100644
--- a/meta/classes/sanity.bbclass
+++ b/meta/classes/sanity.bbclass
@@ -289,7 +289,7 @@ def check_toolchain(data):
             else:
                 seen_libs.append(tune)
             if tune == deftune:
-                tune_error_set.append("Multilib '%s' (%s) is also the default tuning." % (lib, deftune))
+                tune_error_set.append("Multilib '%s' (%s:%s) is also the default tuning." % (lib, tune,deftune))
             else:
                 tune_errors = check_toolchain_tune(data, tune, lib)
             if tune_errors:
diff --git a/meta/classes/siteinfo.bbclass b/meta/classes/siteinfo.bbclass
index 50141a3..54d6f8f 100644
--- a/meta/classes/siteinfo.bbclass
+++ b/meta/classes/siteinfo.bbclass
@@ -18,6 +18,7 @@
 def siteinfo_data(d):
     archinfo = {
         "allarch": "endian-little bit-32", # bogus, but better than special-casing the checks below for allarch
+        "aarch64-linux-ilp32": "endian-little bit-32 arm-common arm-32",
         "aarch64": "endian-little bit-64 arm-common arm-64",
         "aarch64_be": "endian-big bit-64 arm-common arm-64",
         "arm": "endian-little bit-32 arm-common arm-32",
@@ -58,6 +59,7 @@ def siteinfo_data(d):
         "linux-gnun32": "common-linux common-glibc",
         "linux-gnueabi": "common-linux common-glibc",
         "linux-gnuspe": "common-linux common-glibc",
+        "linux-ilp32": "common-linux common-glibc",
         "linux-uclibc": "common-linux common-uclibc",
         "linux-uclibceabi": "common-linux common-uclibc",
         "linux-uclibcspe": "common-linux common-uclibc",
@@ -69,6 +71,10 @@ def siteinfo_data(d):
         "mingw32": "common-mingw",
     }
     targetinfo = {
+        "aarch64-linux": "bit-64 arm64",
+        "aarch64_be-linux": "bit-64 arm64",
+        "aarch64-linux-gnuilp32": "bit-32 arm-32",
+        "aarch64_be-linux-gnuilp32": "bit-32 aarch64_be-linux arm-32",
         "aarch64-linux-gnu": "aarch64-linux",
         "aarch64_be-linux-gnu": "aarch64_be-linux",
         "aarch64-linux-musl": "aarch64-linux",
diff --git a/meta/recipes-devtools/gcc/gcc-multilib-config.inc b/meta/recipes-devtools/gcc/gcc-multilib-config.inc
index a0a2ac0..ca3d1cc 100644
--- a/meta/recipes-devtools/gcc/gcc-multilib-config.inc
+++ b/meta/recipes-devtools/gcc/gcc-multilib-config.inc
@@ -207,6 +207,8 @@ python gcc_multilib_setup() {
             libdirn32 = tune_baselib
         elif tune_baselib == 'lib':
             libdir32 = tune_baselib
+        elif tune_baselib == 'libilp32':
+            libdir32 = tune_baselib
         else:
             bb.error('Unknown libdir (%s) of the tune : %s' % (tune_baselib, tune))
 
-- 
2.5.0

